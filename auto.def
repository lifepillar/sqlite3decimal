# vim: ft=tcl
use cc cc-db cc-lib cc-shared

options {
  static => "Build a static library"
}

#
# @proj-file-content ?-trim? filename
#
# Opens the given file, reads all of its content, and returns it.  If
# the first arg is -trim, the contents of the file named by the second
# argument are trimmed before returning them.
#
# Source: https://sqlite.org/src/file?name=autosetup/proj.tcl
#
proc proj-file-content {args} {
  set trim 0
  set fname $args
  if {"-trim" eq [lindex $args 0]} {
    set trim 1
    lassign $args - fname
  }
  set fp [open $fname rb]
  set rc [read $fp]
  close $fp
  if {$trim} { return [string trim $rc] }
  return $rc
}

define NAME "sqlite3decimal"
define VERSION [proj-file-content -trim $::autosetup(srcdir)/VERSION]

if {[opt-bool debug]} {
  define CFLAGS {-g -O0}
  define-append CFLAGS -DDEBUG
  define DECFLAGS {-DDECPRINT=1 -DDECCHECK=1 -DDECALLOC=1}
  msg-result "Debugging support enabled"
} else {
  define CFLAGS {-Os}
  define-append CFLAGS -DNDEBUG
  define DECFLAGS {-DDECPRINT=0 -DDECCHECK=0 -DDECALLOC=0}
}
define EXTRA_CFLAGS {-std=c2x -pedantic -Wall -Wextra -Wno-unknown-pragmas}

if {[opt-bool static]} {
  msg-result "Building a static library"
  define DEC_STATICLIB
} else {
  msg-result "Building a shared library"
}

cc-check-endian
cc-check-tools ar ranlib strip

cc-with {-includes {stdint.h inttypes.h}} {
  cc-check-types uint32_t uint16_t int16_t uint8_t
}

make-config-header src/autoconfig.h
make-template Makefile.in

